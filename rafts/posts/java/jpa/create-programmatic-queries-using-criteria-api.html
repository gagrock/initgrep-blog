<!doctype html>
<html class="no-js" lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="msvalidate.01" content="028DD45A8309143DDE8DAFDD41945FE6" />
<link rel="shortcut icon" type="image/png" href="/assets/images/favicon.png"/>
<meta name="theme-color" content="#000000">
<title>Programmatic Queries using JPA Criteria API - www.initgrep.com  </title>
<meta itemprop="description" name="description" content="Criteria Queries in JPA are type-safe and portable way of fetching data. It provides methods such as Criteria Join, Fetch Join, aggregate functions and subqu..." />
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Programmatic Queries using JPA Criteria API">
<meta property="og:url" content="http://localhost:4000/posts/java/jpa/create-programmatic-queries-using-criteria-api">
<meta property="og:image" content="http://localhost:4000/assets/images/cq1.jpg" />
<meta property="og:site_name" content="www.initgrep.com">
<meta property="article:publisher" content="http://www.facebook.com/initgrep" />
<meta property="article:author" content="https://www.facebook.com/irshsheikh" />
<meta property="article:published_time" content="2019-02-11 00:00:00 +0530" />
<meta property="og:description" content="Criteria Queries in JPA are type-safe and portable way of fetching data. It provides methods such as Criteria Join, Fetch Join, aggregate functions and subqu...">
<link rel="canonical" href="http://localhost:4000/posts/java/jpa/create-programmatic-queries-using-criteria-api" />

<meta name="twitter:card" content="summary_large_image"/>
<meta name="twitter:site" content="@initgrep" />
<meta name="twitter:creator" content="@imshykh">
<meta name="twitter:title" content="Programmatic Queries using JPA Criteria API - www.initgrep.com  ">
<meta name="twitter:description" content="Criteria Queries in JPA are type-safe and portable way of fetching data. It provides methods such as Criteria Join, Fetch Join, aggregate functions and subqu...">
<meta name="twitter:image" content="http://localhost:4000/assets/images/cq1.jpg">

<meta name="google-site-verification" content="" />

<script type="application/ld+json">
{"@context": "http://schema.org",
"@type": "BlogPosting",
"headline": "Programmatic Queries using JPA Criteria API - www.initgrep.com  ",
"image": "http://localhost:4000/assets/images/cq1.jpg",
"datePublished": "2019-02-11 00:00:00 +0530",
"description": "Criteria Queries in JPA are type-safe and portable way of fetching data. It provides methods such as Criteria Join, Fetch Join, aggregate functions and subqu...",
"publisher": {"@type": "Organization",
"logo": {"@type": "ImageObject",
"url": "http://localhost:4000/assets/images/cq1.jpg",
"url": "http://localhost:4000/posts/java/jpa/create-programmatic-queries-using-criteria-api"}
</script>



<!--[if lt IE 9]>
<script src="https://html5shim.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
<link href="//fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link type="text/css" rel="stylesheet" href="/assets/css/main.css"  media="screen,projection"/>
<link rel="stylesheet" type="text/css" href="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.css" />
<script src="//cdnjs.cloudflare.com/ajax/libs/cookieconsent2/3.1.0/cookieconsent.min.js"></script>
<script>
window.addEventListener("load", function(){
window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#edeff5",
      "text": "#333"
    },
    "button": {
      "background": "#333333"
    }
  },
  "position": "bottom-right",
  "content": {
    "message": "Hey there, Thank you for visiting by...\n\n\n <b>initgrep.com</b> uses cookies to ensure you get the best experience.",
    "link": "check our privacy policy",
    "href": "https://www.freeprivacypolicy.com/privacy/view/45d4583efa7b94a6561a193611ee4104"
  }
})});
</script>
</head>
<body>

 <!--- nav content -->   

<div class="navbar-fixed" id="top" >
    <nav class=" white lighten-2 " id ="check_nav" role="navigation" style=" box-shadow: 0 0 1px 0 #DEDADA;">
    <div class="nav-wrapper">

      <a id="logo-container" href="/" 
      class="brand-logo  
black-text

 ">initgrep</a>
      <ul class=" nav_menu right hide-on-med-and-down">
       <li><a class="black-text" id="nav_search"><i class="material-icons">search</i></a></li>
      	<li><a class="pt-sans-bold 
black-text

" href="/about">About</a></li>
         <li><a class=" pt-sans-bold 
black-text

" href="/posts" >Posts<i class="material-icons right">more_vert</i></a></li>

      </ul>

      <!--side menu -->
      <ul id="slide-out" class="side-nav ">
        
        <li>
              <div class="background 

black
">
                  <a href="/"><span class="white-text  pacifo-L">initgrep</span></a>
                  <a id="sidenav_search" class="btn-floating btn-large waves-effect waves-light blue-grey"><i class="material-icons">search</i></a>
              </div> 
        </li>
      <li style="margin-top: 1rem; height: 20px;"></li>
        
         <li>
          <a class=" 
black-text

 " href="/posts/">
            <i class=" material-icons receipt"></i>Posts
          </a>
        </li>
        <li><div class="divider"></div></li>
        <li>
          <a class=" 
black-text

" href="/about">
            <i class=" material-icons android">android</i>About
          </a>
        </li>

      </ul>
      <a href="#" data-activates="slide-out" class=" side_menu button-collapse 
black-text

 show-on-large"><i class="material-icons">sort</i></a>
    </div>
    
  </nav>
</div>


<div class=" content ">


<div class="row " style="margin-bottom: 0;">
<div class="col s12 m10 l8 offset-m1 offset-l2 ">
<div class="row " style="margin-bottom: 0px;">
<div class="col s12 m6 l6 ">
<div class="col s4 m3 l2  ">









  <img class="user " src="/assets/images/pp.jpeg">




</div>
<div class="col s6 m9 l8  margin-top-1">
<a  href="/about/sheikh irshad" class="grey-text  pt-sans-bold author" style="display: block;">sheikh irshad</a>
<a class="grey-text pt-sans datetime ">February 11, 2019</a>         
</div>
</div>
<div class="col s12 m6 l6 hide-on-small-only">
<div class="col s12 m4 right  margin-top-2">
<span class="grey-text right pt-sans-bold readtime" >

  35 mins
 read</span> 
</div>
</div>
</div>
</div>
</div>
<div class="row">
<div class="col s12 m10 l6 offset-m1 offset-l3 ">
<h1 class="valign post-head center black-text pt-sans-bold">Programmatic Queries using JPA Criteria API</h1>
</div>
</div>



  <div class="row">
  <div class="col s12 m12 l3  hide-on-med-and-down">
   <div class="col l12 " style="min-height: 500px;"></div>
   <div class="row">
     <div class="col l12">
      
   </div>
   </div>
  </div>
  <div class="  col s12 m10 l6 offset-m1">
 
   <div class=" content-text col s12 m12 l12 "><p>Java Persistence API (JPA) provides the specification of managing data, such as accessing and persisting data, between Java Objects and the databases.</p>

<p>There are obviously many ways in JPA that could be used to interact with a database such as JPQL(Java Persistence Query Language), Criteria API, and Entity specific methods such as persist, merge, remove, flush etc.</p>

<p>I initially found Criteria API quite intimidating. To be frank, I had to invest quite some time to figure out how it works. It eventually turned out to be quite fluent and simple API and I thought why not just write about the experiences. So here it is, <strong>“Creating Programmatic Queries using JPA Criteria API”</strong>.</p>

<p>Criteria Queries are type-safe and portable. They are written using Java programming language APIs. They use the abstract schema of the persistent entities to find, modify and delete persistent entities by invoking JPA Entity Operations.</p>

<p> </p>

<p>We will be using the following data model for building the criteria queries in this tutorial.</p>

<p><img src="/assets/images/Criteria-object-UML.png" alt="Object Model- UML" />
<em><ins>UML diagram describing the Object Relationship Mapping</ins></em></p>

<p>We have three Objects( ref. to diagram above ) <code class="highlighter-rouge">Student</code> , <code class="highlighter-rouge">Course</code> and <code class="highlighter-rouge">Passport</code>. Each of the Objects has a relationship with each other:</p>
<ul>
  <li><code class="highlighter-rouge">Student</code> has a <code class="highlighter-rouge">One-To-One</code> relationship with <code class="highlighter-rouge">Passport</code>. It means that Each Student can only have one Passport and vice versa.</li>
  <li><code class="highlighter-rouge">Student</code> has a <code class="highlighter-rouge">One-To-Many</code> relationship with <code class="highlighter-rouge">Address</code> which means that a Student can have one or more addresses and an address is always assigned to one student.</li>
  <li><code class="highlighter-rouge">Student</code> has a <code class="highlighter-rouge">Many-To-Many</code> relationship with <code class="highlighter-rouge">Course</code> which means that Each Student can enroll in many courses and one course can have many Students enrolled.</li>
</ul>

<p> </p>

<p>We will begin with a simple Criteria Query and slowly build upon it more complex queries.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">public</span> <span class="n">Long</span> <span class="nf">getStudentsCount</span><span class="o">()</span> <span class="o">{</span>
            
        <span class="cm">/** CriteriaBuilder instance**/</span> 
        <span class="n">CriteriaBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">entityManager</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
        
        <span class="cm">/** create a criteriaQuery Object **/</span>
        <span class="n">CriteriaQuery</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">studentQuery</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        
        <span class="cm">/** create a Root Object -&gt; references to the queried entity **/</span>
        <span class="n">Root</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">studentRoot</span> <span class="o">=</span> <span class="n">studentQuery</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        
        <span class="cm">/** Path Object to refer the attribute name of entity **/</span>
        <span class="cm">/** we are not using it for now **/</span>
        <span class="n">Path</span><span class="o">&lt;</span><span class="n">Object</span><span class="o">&gt;</span> <span class="n">namePath</span> <span class="o">=</span> <span class="n">studentRoot</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"name"</span><span class="o">);</span>
        
        <span class="cm">/** Aggregate Expression for count operation  **/</span>
        <span class="n">Expression</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">countExpression</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="n">studentRoot</span><span class="o">);</span>
        
        <span class="cm">/** **/</span>
        <span class="n">studentQuery</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">countExpression</span><span class="o">);</span>
        
        <span class="cm">/** instance of Typed Query */</span>
        <span class="n">TypedQuery</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">typedStudentQuery</span> <span class="o">=</span> 
                            <span class="n">entityManager</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">studentQuery</span><span class="o">);</span>
        
        <span class="cm">/** return the result **/</span>
        <span class="n">Long</span> <span class="n">count</span> <span class="o">=</span> <span class="n">typedStudentQuery</span><span class="o">.</span><span class="na">getSingleResult</span><span class="o">();</span>
        
        <span class="k">return</span> <span class="n">count</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<p><em>The above code example retrieves the total count of students present in the database.</em></p>

<ul>
  <li>A <code class="highlighter-rouge">CriteriaBuilder</code> interface contains all the required methods to build Criteria Queries, Expressions, Ordering, and Predicates.</li>
  <li><code class="highlighter-rouge">CriteriaQuery</code> interface defines functionality required to build a top-level query. It contains the methods that specify the item(s) to be returned in the query result, restrict the result based on certain conditions, group results, specify an order for the result and <a href="https://docs.oracle.com/javaee/6/api/javax/persistence/criteria/CriteriaQuery.html">much more</a>.</li>
  <li><code class="highlighter-rouge">Root</code> interface represents the root entities involved in the query. There could be multiple roots defined in the Criteria Query.</li>
  <li><code class="highlighter-rouge">Path</code> interface represents the path to the attribute in the <code class="highlighter-rouge">root</code> entity.
  <code class="highlighter-rouge">Path</code> interface also <code class="highlighter-rouge">extends</code> to <code class="highlighter-rouge">Expression</code> Interface which contains methods that return Predicates.</li>
  <li><code class="highlighter-rouge">builder.count()</code> is an aggregate method. It returns an expression which would be used for <code class="highlighter-rouge">Selection</code> of the result.</li>
  <li>A <code class="highlighter-rouge">TypedQuery</code> instance is required to run the <code class="highlighter-rouge">CriteriaQuery</code>.</li>
</ul>

<p>The final output of the above example is below :)</p>

<div class="language-sql highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="k">select</span>
        <span class="k">count</span><span class="p">(</span><span class="n">student0_</span><span class="p">.</span><span class="n">id</span><span class="p">)</span> <span class="k">as</span> <span class="n">col_0_0_</span> 
    <span class="k">from</span>
        <span class="n">student</span> <span class="n">student0_</span>
</code></pre></div></div>

<p>It seems quite the over work–doesn’t it. The output of so many lines of code is just a plain old <code class="highlighter-rouge">SELECT</code> query. But the Criteria API was created to serve a different purpose i.e <em>programmable Query API</em>. It helps to build queries dynamically. You could write just one program to build queries for all objects in your application or build queries depending upon your business logic.</p>

<p>Let’s say, we want to get the count of either Students, Courses or any other entities present in our application. We could either write different queries for each of them or we could only use Criteria API.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">Long</span> <span class="nf">getCountOfEntity</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">claz</span><span class="o">)</span> <span class="o">{</span>
            
        <span class="n">CriteriaBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
        <span class="n">CriteriaQuery</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">studentQuery</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Root</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">root</span> <span class="o">=</span> <span class="n">studentQuery</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">claz</span><span class="o">);</span>
        <span class="n">Expression</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">countExpression</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
        <span class="n">studentQuery</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">countExpression</span><span class="o">);</span>
        <span class="n">TypedQuery</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">typedStudentQuery</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">studentQuery</span><span class="o">);</span>
        
        <span class="k">return</span> <span class="n">typedStudentQuery</span><span class="o">.</span><span class="na">getSingleResult</span><span class="o">();</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>I have only updated the previous example to allow the generic parameter which specifies the <code class="highlighter-rouge">Class</code> of the <code class="highlighter-rouge">Entity</code>. Rest of the Code stays the same. You can learn more about Java Generics <a href="https://docs.oracle.com/javase/tutorial/java/generics/index.html">here</a>.</p>

<p>Let’s look at the above example in detail.</p>

<p><strong>Criteria Query</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     <span class="n">CriteriaQuery</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">createQuery</span><span class="o">(</span><span class="n">Class</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">resultClass</span><span class="o">);</span>
</code></pre></div></div>
<p><code class="highlighter-rouge">CreateQuery</code> method takes the <code class="highlighter-rouge">Class</code> name of the result type as an argument.</p>
<ul>
  <li>If the result is returned as a data-set related to the entity e.g all the students or one of the student. The parameter should be <code class="highlighter-rouge">Student.class</code>.
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>      <span class="n">builder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div>    </div>
  </li>
  <li>If the query returns any other result irrespective of which entity it works on, It should have a parameter of the returned type. As we saw above, when the count was returned, the parameter type was  <code class="highlighter-rouge">Long.class</code></li>
</ul>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">builder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</code></pre></div></div>

<p><strong>Root</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">Root</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="n">root</span> <span class="o">=</span> <span class="n">studentQuery</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">Class</span><span class="o">)</span>
</code></pre></div></div>
<p>The <code class="highlighter-rouge">Root</code> refers to the entity on which the query would be run such as <code class="highlighter-rouge">Student.class</code> in the above example.</p>

<p><strong>Select</strong></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">studentQuery</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">countExpression</span><span class="o">);</span>    
</code></pre></div></div>

<p>The <code class="highlighter-rouge">select</code> method specifies the result to be returned by the Query. If all the attributes of an entity are supposed to be returned instead of just returning the count, we could pass the <code class="highlighter-rouge">root</code> entity as the parameter such as below.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">studentQuery</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">studentRoot</span><span class="o">);</span>
</code></pre></div></div>

<p> </p>
<h3 id="inheritance-relationships">Inheritance Relationships</h3>

<p> </p>

<p><img src="/assets/images/apidaigram.png" alt="Interface relationships in Criteria API" />
<em><ins>Interface relationships in Criteria API</ins></em></p>

<p>In the Above diagram, observe the classes in a blue background. The relationship tree explains the inheritance hierarchy among various interfaces present in the Criteria API.</p>

<p><code class="highlighter-rouge">Selection</code> is at the top and being extended by <code class="highlighter-rouge">Expression</code>. <code class="highlighter-rouge">Expression</code> in turn is being extended by <code class="highlighter-rouge">Predicate</code> and <code class="highlighter-rouge">Path</code> interfaces. <code class="highlighter-rouge">From</code> interface extends path which in turn is the parent of both <code class="highlighter-rouge">Root</code> and <code class="highlighter-rouge">Join</code> Interface.</p>

<p><code class="highlighter-rouge">Root</code> Interface is also an expression. It means, we can query a complete entity by passing <code class="highlighter-rouge">Root</code> as a parameter to the <code class="highlighter-rouge">CriteriaQuery.select</code> method.
In case we want to fetch a selected attribute, we can fetch the attribute path using <code class="highlighter-rouge">root.get(attributeName)</code>. This method returns a <code class="highlighter-rouge">Path</code>  object which inherits <code class="highlighter-rouge">expression</code>.</p>

<p> </p>

<h3 id="criteria-joins">Criteria Joins</h3>

<p> </p>
<h4 id="implicit-join">Implicit Join</h4>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"addresses"</span><span class="o">);</span>
</code></pre></div></div>
<p>When a collection parameter is passed to the get method, it creates a path to corresponding referenced <strong>collection-valued attribute</strong>. This results in the creation of an <code class="highlighter-rouge">INNER JOIN</code> query.</p>

<p>Let’s go back to our domain objects. <code class="highlighter-rouge">Student</code> has a <code class="highlighter-rouge">OneToMany</code> relationship with <code class="highlighter-rouge">Address</code>. To fetch the <code class="highlighter-rouge">address</code>, we can use the <code class="highlighter-rouge">root.get('address')</code>. Below is an example.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">CriteriaBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
        <span class="n">CriteriaQuery</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">cq</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Root</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">root</span> <span class="o">=</span> <span class="n">cq</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">cq</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"addresses"</span><span class="o">));</span>
        <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">cq</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span>
</code></pre></div></div>

<p>Output Query for the above example looks like as below:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="n">select</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">id</span> <span class="n">as</span> <span class="n">id1_0_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">city_code</span> <span class="n">as</span> <span class="n">city_cod2_0_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">city_lang</span> <span class="n">as</span> <span class="n">city_lan3_0_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">city_name</span> <span class="n">as</span> <span class="n">city_d</span> <span class="n">nam4_0_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">country</span> <span class="n">as</span> <span class="n">country5_0_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">house_number</span> <span class="n">as</span> <span class="n">house_nu6_0_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">street</span> <span class="n">as</span> <span class="n">street7_0_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">student_id</span> <span class="n">as</span> <span class="n">student_9_0_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">zip_code</span> <span class="n">as</span> <span class="n">zip_code8_0_</span> 
    <span class="n">from</span>
        <span class="n">student</span> <span class="n">student0_</span> 
    <span class="n">inner</span> <span class="n">join</span>
        <span class="n">address</span> <span class="n">addresses1_</span> 
            <span class="n">on</span> <span class="n">student0_</span><span class="o">.</span><span class="na">id</span><span class="o">=</span><span class="n">addresses1_</span><span class="o">.</span><span class="na">student_id</span>
</code></pre></div></div>

<p>Note: Since the Address is the Owner of the relationship between Student and Address. By default, the fetch type for a <code class="highlighter-rouge">OneToMany</code> relationship is lazy fetch. As a result, there would be extra queries fired to initialize the Student entities related to each Address. However, If we add a where clause and specify a <code class="highlighter-rouge">restriction or predicate</code>, it would only result in a Single Query.</p>

<p> </p>
<h4 id="explicit-join">Explicit Join</h4>

<p>Ideally, when we define relationships in JPA, the Join will be based on the related ID column. However, if we want to define the restriction based on some other column, <code class="highlighter-rouge">Join.on(Predicate...)</code> can be used. <code class="highlighter-rouge">Join</code> also provides a way to traverse the attributes of the joined entity such as <code class="highlighter-rouge">join.get(attributeName)</code>.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">CriteriaBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
        <span class="n">CriteriaQuery</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">cq</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Root</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">root</span> <span class="o">=</span> <span class="n">cq</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Join</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">,</span> <span class="n">Address</span><span class="o">&gt;</span> <span class="n">join</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"addresses"</span><span class="o">);</span>
        <span class="cm">/** the below statement is only for the illustration only.
            the join relationship will by-default be id and reference id
        **/</span>
        <span class="n">join</span><span class="o">.</span><span class="na">on</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">equal</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">),</span> <span class="n">join</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"student"</span><span class="o">)));</span>
        <span class="n">cq</span><span class="o">.</span><span class="na">multiselect</span><span class="o">(</span><span class="n">join</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">resultList</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">cq</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span>
</code></pre></div></div>

<p>The output of the above code example is quite different than what we saw in the implicit join. The initial query only fetches the address id by doing the <code class="highlighter-rouge">INNER JOIN</code>. Each of the entities in the relationship is fetched lazily using separate queries</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="n">select</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">id</span> <span class="n">as</span> <span class="n">col_0_0_</span> 
    <span class="n">from</span>
        <span class="n">student</span> <span class="n">student0_</span> 
    <span class="n">inner</span> <span class="n">join</span>
        <span class="n">address</span> <span class="n">addresses1_</span> 
            <span class="n">on</span> <span class="n">student0_</span><span class="o">.</span><span class="na">id</span><span class="o">=</span><span class="n">addresses1_</span><span class="o">.</span><span class="na">student_id</span> 
</code></pre></div></div>

<p>After all the Id’s are fetched, One query is used to fetch Student and Address details by doing an <code class="highlighter-rouge">OUTER JOIN</code> on Student id and address.Student_id.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="n">select</span>
        <span class="n">address0_</span><span class="o">.</span><span class="na">id</span> <span class="n">as</span> <span class="n">id1_0_0_</span><span class="o">,</span>
        <span class="n">address0_</span><span class="o">.</span><span class="na">city_code</span> <span class="n">as</span> <span class="n">city_cod2_0_0_</span><span class="o">,</span>
        <span class="n">address0_</span><span class="o">.</span><span class="na">city_lang</span> <span class="n">as</span> <span class="n">city_lan3_0_0_</span><span class="o">,</span>
        <span class="n">address0_</span><span class="o">.</span><span class="na">city_name</span> <span class="n">as</span> <span class="n">city_nam4_0_0_</span><span class="o">,</span>
        <span class="n">address0_</span><span class="o">.</span><span class="na">country</span> <span class="n">as</span> <span class="n">country5_0_0_</span><span class="o">,</span>
        <span class="n">address0_</span><span class="o">.</span><span class="na">house_number</span> <span class="n">as</span> <span class="n">house_nu6_0_0_</span><span class="o">,</span>
        <span class="n">address0_</span><span class="o">.</span><span class="na">street</span> <span class="n">as</span> <span class="n">street7_0_0_</span><span class="o">,</span>
        <span class="n">address0_</span><span class="o">.</span><span class="na">student_id</span> <span class="n">as</span> <span class="n">student_9_0_0_</span><span class="o">,</span>
        <span class="n">address0_</span><span class="o">.</span><span class="na">zip_code</span> <span class="n">as</span> <span class="n">zip_code8_0_0_</span><span class="o">,</span>
        <span class="n">student1_</span><span class="o">.</span><span class="na">id</span> <span class="n">as</span> <span class="n">id1_4_1_</span><span class="o">,</span>
        <span class="n">student1_</span><span class="o">.</span><span class="na">name</span> <span class="n">as</span> <span class="n">name2_4_1_</span><span class="o">,</span>
        <span class="n">student1_</span><span class="o">.</span><span class="na">passport_id</span> <span class="n">as</span> <span class="n">passport3_4_1_</span> 
    <span class="n">from</span>
        <span class="n">address</span> <span class="n">address0_</span> 
    <span class="n">left</span> <span class="n">outer</span> <span class="n">join</span>
        <span class="n">student</span> <span class="n">student1_</span> 
            <span class="n">on</span> <span class="n">address0_</span><span class="o">.</span><span class="na">student_id</span><span class="o">=</span><span class="n">student1_</span><span class="o">.</span><span class="na">id</span> 
    <span class="n">where</span>
        <span class="n">address0_</span><span class="o">.</span><span class="na">id</span><span class="o">=?</span>
</code></pre></div></div>
<p>Note: If a restriction is provided in <code class="highlighter-rouge">where</code> method of the <code class="highlighter-rouge">CritieriaQuery</code>. It would result in a single query.</p>

<p> </p>

<h4 id="fetch-join">Fetch Join</h4>

<p><code class="highlighter-rouge">FETCH</code> tells the JPA to override the declarative fetch definitions provided through annotation such as <code class="highlighter-rouge">@ManyToMany(fetch=FetchType.LAZY)</code> and initialize all the associations or relationships eagerly. As a result, only one query is created.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>        <span class="n">CriteriaBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
        <span class="n">CriteriaQuery</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">cq</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Root</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">root</span> <span class="o">=</span> <span class="n">cq</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">root</span><span class="o">.</span><span class="na">fetch</span><span class="o">(</span><span class="s">"addresses"</span><span class="o">);</span>
        <span class="n">cq</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
        <span class="n">List</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">resultList</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">cq</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span>
</code></pre></div></div>

<p><em>The above query output is only a single query as below:</em></p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="n">select</span>
        <span class="n">student0_</span><span class="o">.</span><span class="na">id</span> <span class="n">as</span> <span class="n">id1_4_0_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">id</span> <span class="n">as</span> <span class="n">id1_0_1_</span><span class="o">,</span>
        <span class="n">student0_</span><span class="o">.</span><span class="na">name</span> <span class="n">as</span> <span class="n">name2_4_0_</span><span class="o">,</span>
        <span class="n">student0_</span><span class="o">.</span><span class="na">passport_id</span> <span class="n">as</span> <span class="n">passport3_4_0_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">city_code</span> <span class="n">as</span> <span class="n">city_cod2_0_1_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">city_lang</span> <span class="n">as</span> <span class="n">city_lan3_0_1_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">city_name</span> <span class="n">as</span> <span class="n">city_nam4_0_1_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">country</span> <span class="n">as</span> <span class="n">country5_0_1_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">house_number</span> <span class="n">as</span> <span class="n">house_nu6_0_1_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">street</span> <span class="n">as</span> <span class="n">street7_0_1_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">student_id</span> <span class="n">as</span> <span class="n">student_9_0_1_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">zip_code</span> <span class="n">as</span> <span class="n">zip_code8_0_1_</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">student_id</span> <span class="n">as</span> <span class="n">student_9_0_0__</span><span class="o">,</span>
        <span class="n">addresses1_</span><span class="o">.</span><span class="na">id</span> <span class="n">as</span> <span class="n">id1_0_0__</span> 
    <span class="n">from</span>
        <span class="n">student</span> <span class="n">student0_</span> 
    <span class="n">inner</span> <span class="n">join</span>
        <span class="n">address</span> <span class="n">addresses1_</span> 
            <span class="n">on</span> <span class="n">student0_</span><span class="o">.</span><span class="na">id</span><span class="o">=</span><span class="n">addresses1_</span><span class="o">.</span><span class="na">student_id</span>
</code></pre></div></div>

<p> </p>

<h3 id="group-by-and-having-clause">Group By and Having clause</h3>

<p><code class="highlighter-rouge">Group By</code> Clause is used to group rows with similar values. <code class="highlighter-rouge">Having</code> Clause is used to add restrictions for <a href="https://docs.oracle.com/database/121/SQLRF/functions003.htm#SQLRF20035">aggregate functions</a>.</p>

<p><code class="highlighter-rouge">groupBy</code> method is part of the <code class="highlighter-rouge">CriteriaQuery</code> Interface. It either takes a List of <code class="highlighter-rouge">Expressions</code> as parameters. These expressions are used to form groups over the query results. Below is the signature of the <code class="highlighter-rouge">groupBy</code> methods.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="cm">/*
    * @param grouping  zero or more grouping expressions
    * @return the modified query
    */</span>
    <span class="n">CriteriaQuery</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">groupBy</span><span class="o">(</span><span class="n">Expression</span><span class="o">&lt;?&gt;...</span> <span class="n">grouping</span><span class="o">);</span>

    <span class="cm">/*
    * @param grouping  list of zero or more grouping expressions
    * @return the modified query
    */</span>
    <span class="n">CriteriaQuery</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">groupBy</span><span class="o">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Expression</span><span class="o">&lt;?&gt;&gt;</span> <span class="n">grouping</span><span class="o">);</span>
</code></pre></div></div>

<p>Similarly, <code class="highlighter-rouge">having</code> method is part of the <code class="highlighter-rouge">CriteriaQuery</code> Interface. It either takes a simple or compound boolean <code class="highlighter-rouge">Expression</code> or one or more <code class="highlighter-rouge">Predicates</code> as parameters. The expression or predicates provided specify the restrictions over the groups of the query.
Below is the signature of the <code class="highlighter-rouge">having</code> methods.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="cm">/**
     * @param restriction  a simple or compound boolean expression
     * @return the modified query
     */</span>
    <span class="n">CriteriaQuery</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">having</span><span class="o">(</span><span class="n">Expression</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;</span> <span class="n">restriction</span><span class="o">);</span>

    <span class="cm">/**
     * @param restrictions  zero or more restriction predicates
     * @return the modified query
     */</span>
    <span class="n">CriteriaQuery</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span> <span class="nf">having</span><span class="o">(</span><span class="n">Predicate</span><span class="o">...</span> <span class="n">restrictions</span><span class="o">);</span>
</code></pre></div></div>

<p>To build a Criteria Query which uses the <code class="highlighter-rouge">group by</code> and <code class="highlighter-rouge">having</code> methods–
Let’s assume, we need to fetch all the <code class="highlighter-rouge">Students</code> with the number of <code class="highlighter-rouge">Addresses</code> greater than or equal to three(3).</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">CriteriaBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
    <span class="n">CriteriaQuery</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">cq</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="cm">/** Query the address entity **/</span>
    <span class="n">Root</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">root</span> <span class="o">=</span> <span class="n">cq</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">Address</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="cm">/** join with student to fetch the student_id **/</span>
    <span class="n">Join</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">,</span> <span class="n">Student</span><span class="o">&gt;</span> <span class="n">joinOnStudent</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"student"</span><span class="o">);</span>
    <span class="cm">/** count expression on the address_id **/</span>
    <span class="n">Expression</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">count</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">));</span>
    <span class="cm">/** fetch students , group by student_id , habving count &gt;= 3 **/</span>
    <span class="n">cq</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">joinOnStudent</span><span class="o">)</span>
        <span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="n">joinOnStudent</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">))</span>
        <span class="o">.</span><span class="na">having</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">ge</span><span class="o">(</span><span class="n">count</span><span class="o">,</span> <span class="mi">3</span><span class="o">));</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">resultList</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">cq</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span>
</code></pre></div></div>

<p>The output results in an SQL with an <code class="highlighter-rouge">INNER JOIN</code> between Student and Address on Student_id column. It fetches students with restrictions provided by <code class="highlighter-rouge">HAVING</code> clause on aggregate function mentioned by <code class="highlighter-rouge">Group By</code> clause.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">Hibernate:</span> 
    <span class="n">select</span>
        <span class="n">student1_</span><span class="o">.</span><span class="na">id</span> <span class="n">as</span> <span class="n">id1_4_</span><span class="o">,</span>
        <span class="n">student1_</span><span class="o">.</span><span class="na">name</span> <span class="n">as</span> <span class="n">name2_4_</span><span class="o">,</span>
        <span class="n">student1_</span><span class="o">.</span><span class="na">passport_id</span> <span class="n">as</span> <span class="n">passport3_4_</span> 
    <span class="n">from</span>
        <span class="n">address</span> <span class="n">address0_</span> 
    <span class="n">inner</span> <span class="n">join</span>
        <span class="n">student</span> <span class="n">student1_</span> 
            <span class="n">on</span> <span class="n">address0_</span><span class="o">.</span><span class="na">student_id</span><span class="o">=</span><span class="n">student1_</span><span class="o">.</span><span class="na">id</span> 
    <span class="n">group</span> <span class="n">by</span>
        <span class="n">student1_</span><span class="o">.</span><span class="na">id</span> 
    <span class="n">having</span>
        <span class="nf">count</span><span class="o">(</span><span class="n">address0_</span><span class="o">.</span><span class="na">id</span><span class="o">)&gt;=</span><span class="mi">3</span>
</code></pre></div></div>

<p> </p>
<h3 id="order-by">Order By</h3>

<p>The <code class="highlighter-rouge">order by</code> keyword is used to sort the fetched data either in ascending order or descending order of the value of a column. It can also include aggregate functions.</p>

<p>The <code class="highlighter-rouge">Order</code> interface provides the below methods</p>
<ul>
  <li><code class="highlighter-rouge">reverse()</code> method switches the ordering.</li>
  <li><code class="highlighter-rouge">isAscending()</code> checks whether ascending order is in place.</li>
  <li><code class="highlighter-rouge">getExpression()</code> fetches the expression that is used for ordering.</li>
</ul>

<p> </p>

<p>The <code class="highlighter-rouge">CriteriaBuilder</code> interface provides the following methods to enforce order in a criteria query.</p>
<ul>
  <li><code class="highlighter-rouge">asc(Expression&lt;?&gt; x)</code>: this method returns an <code class="highlighter-rouge">Order</code> instance which enforces an ascending order by the value of the expression provided as the parameter.</li>
  <li><code class="highlighter-rouge">desc(Expression&lt;?&gt; x)</code>: this method returns an <code class="highlighter-rouge">Order</code> instance which enforces a descending order by the value of the expression provided as the parameter.</li>
</ul>

<p>Let’s modify the above example to add the descending order such that we have all the students in descending order of the number of addresses.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">CriteriaBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
    <span class="n">CriteriaQuery</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">cq</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">Root</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">root</span> <span class="o">=</span> <span class="n">cq</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">Address</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">Join</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">,</span> <span class="n">Student</span><span class="o">&gt;</span> <span class="n">joinOnStudent</span> <span class="o">=</span> <span class="n">root</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"student"</span><span class="o">);</span>

    <span class="n">Expression</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">count</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">));</span>
    <span class="n">cq</span>
        <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">joinOnStudent</span><span class="o">)</span>
            <span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="n">joinOnStudent</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">))</span>
                <span class="o">.</span><span class="na">having</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">ge</span><span class="o">(</span><span class="n">count</span><span class="o">,</span> <span class="mi">3</span><span class="o">))</span>
                        <span class="o">.</span><span class="na">orderBy</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">desc</span><span class="o">(</span><span class="n">count</span><span class="o">));</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">resultList</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">cq</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span>
</code></pre></div></div>

<p>The output query produced by the above criteria query is below:</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">select</span>
        <span class="n">student1_</span><span class="o">.</span><span class="na">id</span> <span class="n">as</span> <span class="n">id1_4_</span><span class="o">,</span>
        <span class="n">student1_</span><span class="o">.</span><span class="na">name</span> <span class="n">as</span> <span class="n">name2_4_</span><span class="o">,</span>
        <span class="n">student1_</span><span class="o">.</span><span class="na">passport_id</span> <span class="n">as</span> <span class="n">passport3_4_</span> 
    <span class="n">from</span>
        <span class="n">address</span> <span class="n">address0_</span> 
    <span class="n">inner</span> <span class="n">join</span>
        <span class="n">student</span> <span class="n">student1_</span> 
            <span class="n">on</span> <span class="n">address0_</span><span class="o">.</span><span class="na">student_id</span><span class="o">=</span><span class="n">student1_</span><span class="o">.</span><span class="na">id</span> 
    <span class="n">group</span> <span class="n">by</span>
        <span class="n">student1_</span><span class="o">.</span><span class="na">id</span> 
    <span class="n">having</span>
        <span class="nf">count</span><span class="o">(</span><span class="n">address0_</span><span class="o">.</span><span class="na">id</span><span class="o">)&gt;=</span><span class="mi">3</span>
    <span class="n">order</span> <span class="n">by</span>
        <span class="nf">count</span><span class="o">(</span><span class="n">address0_</span><span class="o">.</span><span class="na">id</span><span class="o">)</span> <span class="n">asc</span>
</code></pre></div></div>

<p> </p>
<h3 id="subquery">Subquery</h3>

<p>A <code class="highlighter-rouge">subquery</code> is a nested query which is embedded in the <code class="highlighter-rouge">WHERE</code> clause of the main query. The results of the subquery are consumed by the main query.</p>

<p><code class="highlighter-rouge">subquery</code> method is part of <a href="https://docs.oracle.com/javaee/7/api/javax/persistence/criteria/CommonAbstractCriteria.html">CommonAbstractCriteria</a> interface. This interface provides functionality which is common to both top-level criteria queries as well as subqueries.</p>

<p>Let’s change the above example to include a subquery.</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">CriteriaBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">getCriteriaBuilder</span><span class="o">();</span>
    <span class="n">CriteriaQuery</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">cq</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">Root</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">root</span> <span class="o">=</span> <span class="n">cq</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">Student</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">cq</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">root</span><span class="o">);</span>
        <span class="cm">/** Subquery is created from the main criteria query **/</span>
        <span class="n">Subquery</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">subquery</span> <span class="o">=</span> <span class="n">cq</span><span class="o">.</span><span class="na">subquery</span><span class="o">(</span><span class="n">Long</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Root</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">&gt;</span> <span class="n">subRoot</span> <span class="o">=</span> <span class="n">subquery</span><span class="o">.</span><span class="na">from</span><span class="o">(</span><span class="n">Address</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">Join</span><span class="o">&lt;</span><span class="n">Address</span><span class="o">,</span> <span class="n">Student</span><span class="o">&gt;</span> <span class="n">joinOnStudent</span> <span class="o">=</span> <span class="n">subRoot</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s">"student"</span><span class="o">);</span>
        <span class="n">Path</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">idPath</span> <span class="o">=</span> <span class="n">joinOnStudent</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">);</span>
        <span class="n">Expression</span><span class="o">&lt;</span><span class="n">Long</span><span class="o">&gt;</span> <span class="n">idCountExp</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="na">count</span><span class="o">(</span><span class="n">subRoot</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">));</span>
        <span class="n">subquery</span>
            <span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">idPath</span><span class="o">)</span>
                <span class="o">.</span><span class="na">groupBy</span><span class="o">(</span><span class="n">idPath</span><span class="o">)</span>
                    <span class="o">.</span><span class="na">having</span><span class="o">(</span><span class="n">builder</span><span class="o">.</span><span class="na">ge</span><span class="o">(</span><span class="n">idCountExp</span><span class="o">,</span> <span class="mi">3</span><span class="o">));</span>

    <span class="cm">/** subquery is provided as a parameter to the where method **/</span>
    <span class="n">cq</span><span class="o">.</span><span class="na">where</span><span class="o">(</span><span class="n">root</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="s">"id"</span><span class="o">).</span><span class="na">in</span><span class="o">(</span><span class="n">subquery</span><span class="o">));</span>

    <span class="n">List</span><span class="o">&lt;</span><span class="n">Student</span><span class="o">&gt;</span> <span class="n">resultList</span> <span class="o">=</span> <span class="n">em</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="n">cq</span><span class="o">).</span><span class="na">getResultList</span><span class="o">();</span>
</code></pre></div></div>

<p>Below is the output of the final query produced–</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">select</span>
        <span class="n">student0_</span><span class="o">.</span><span class="na">id</span> <span class="n">as</span> <span class="n">id1_4_</span><span class="o">,</span>
        <span class="n">student0_</span><span class="o">.</span><span class="na">name</span> <span class="n">as</span> <span class="n">name2_4_</span><span class="o">,</span>
        <span class="n">student0_</span><span class="o">.</span><span class="na">passport_id</span> <span class="n">as</span> <span class="n">passport3_4_</span> 
    <span class="n">from</span>
        <span class="n">student</span> <span class="n">student0_</span> 
    <span class="n">where</span>
        <span class="n">student0_</span><span class="o">.</span><span class="na">id</span> <span class="nf">in</span> <span class="o">(</span>
            <span class="n">select</span>
                <span class="n">student2_</span><span class="o">.</span><span class="na">id</span> 
            <span class="n">from</span>
                <span class="n">address</span> <span class="n">address1_</span> 
            <span class="n">inner</span> <span class="n">join</span>
                <span class="n">student</span> <span class="n">student2_</span> 
                    <span class="n">on</span> <span class="n">address1_</span><span class="o">.</span><span class="na">student_id</span><span class="o">=</span><span class="n">student2_</span><span class="o">.</span><span class="na">id</span> 
            <span class="n">group</span> <span class="n">by</span>
                <span class="n">student2_</span><span class="o">.</span><span class="na">id</span> 
            <span class="n">having</span>
                <span class="nf">count</span><span class="o">(</span><span class="n">address1_</span><span class="o">.</span><span class="na">id</span><span class="o">)&gt;=</span><span class="mi">3</span>
        <span class="o">)</span>
            
</code></pre></div></div>

<p> </p>
<h3 id="aggregate-functions">Aggregate Functions</h3>

<p>Criteria API supports the aggregate functions such as <code class="highlighter-rouge">count</code>, <code class="highlighter-rouge">avg</code>, <code class="highlighter-rouge">max</code>, and <code class="highlighter-rouge">min</code> etc. All the aggregate functions are part of the  <a href="https://docs.oracle.com/javaee/6/api/javax/persistence/criteria/CriteriaBuilder.html">CriteriaBuilder</a> Interface.</p>

</div>
   <div class=" col s12 m12 l12 "> <div class="content">
<p>Please feel free to pass your feedback in the comments. Thank you for stopping by.</p>

</div>



<div id="disqus_thread"></div>
<script>
var PAGE_URL = "https://www.initgrep.com//posts/java/jpa/create-programmatic-queries-using-criteria-api"; 
var PAGE_IDENTIFIER = "/posts/java/jpa/create-programmatic-queries-using-criteria-api"
var disqus_config = function () {
this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
};

(function() { // DON'T EDIT BELOW THIS LINE
var d = document, s = d.createElement('script');
s.src = 'https://www-initgrep-com.disqus.com/embed.js';
s.setAttribute('data-timestamp', +new Date());
(d.head || d.body).appendChild(s);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>



</div>
   

   </div>
  <div class="col s12 m12 l3  hide-on-med-and-down ">
     <div class="col l12 " style="min-height: 500px;"></div>
   <div class="row">
     <div class="col l12">
      
   </div>
   </div>
  </div>
  </div>

</div>

<div id="search">
    <div class="section">
       <div class="row">
         <div class="col s12 m12">
          <a class=" close btn-floating waves-effect waves-light btn-small black right ">
              <i class="large material-icons">close</i>
          </a>
         </div>
       </div> 
       <div class="row">
        <div class="input-field col s12 m8 offset-m2">
          <i class="material-icons prefix">search</i>
          <input id="icon_prefix" type="text" class="validate doSearch" >
          <label for="icon_prefix">Search</label>
        </div>
    </div>
  <div class="row  ">
    <div class=" container ">
       <div class="row searchContainer ">
        
      </div>
    </div>

  </div>

   </div> 
</div>

<footer class="page-footer white" id="">
        
    <div class="footer-copyright">
      <div class="container">
       <a class="blue-grey-text " href="/about/sheikh irshad">Made with <i class="material-icons teal-text lighten-4">favorite</i> by me</a>
      </div>
    </div>
  </footer>

 <script type="text/javascript" src="//code.jquery.com/jquery-2.1.1.min.js"></script>
<script type="text/javascript" src="/assets/js/materialize.min.js"></script>
<script type="text/javascript" src="/assets/js/properties.js"></script> 
<script type="text/javascript" src="/assets/js/init.js"></script> 
<script type="text/javascript" src="/assets/js/lunr.min.js"></script> 
<script type="text/javascript" src="/assets/js/data.js"></script>       
<script id="dsq-count-scr" src="//www-initgrep-com.disqus.com/count.js" async></script>




</body>
</html>



